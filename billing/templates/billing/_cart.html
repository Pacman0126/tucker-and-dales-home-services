{% load static %}

<div class="card mt-4 shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong>🛒 Your Booking Cart</strong>
    <span class="badge bg-dark">{{ cart.items.count }} item{{ cart.items.count|pluralize }}</span>
  </div>

  <div class="card-body">
    {% if cart and cart.item_count %}
      <form id="cart-form" method="post">
        {% csrf_token %}

        <!-- TABLE VIEW -->
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-3">
            <thead class="table-light">
              <tr>
                <th style="width: 40px;">
                  <input type="checkbox" id="select-all" class="form-check-input">
                </th>
                <th style="min-width: 120px;">Date</th>
                <th>Service</th>
                <th>Time Slot</th>
                <th>Employee</th>
                <th class="text-end" style="min-width: 100px;">Price</th>
                <th class="text-end" style="width: 80px;">Action</th>
              </tr>
            </thead>
            <tbody id="cart-item-list">
              {% for item in cart.items.all %}
              <tr>
                <td>
                  <input type="checkbox"
                         class="form-check-input"
                         name="selected_items"
                         value="{{ item.id }}">
                </td>
                <td class="text-nowrap">{{ item.date }}</td>
                <td class="fw-semibold">{{ item.service_category.name }}</td>
                <td>{{ item.time_slot.label }}</td>
                <td class="text-nowrap">{{ item.employee.name }}</td>
                <td class="text-end fw-semibold text-success">
                  ${{ item.unit_price|floatformat:2 }}
                </td>
                <td class="text-end">
                  <button type="button"
                          class="btn btn-sm btn-outline-danger"
                          data-action="remove"
                          data-item-id="{{ item.id }}">
                    <i class="bi bi-trash"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No items in your cart yet.
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Totals -->
        <div class="border-top pt-3 mt-2">
          <div class="d-flex justify-content-between">
            <span>Subtotal:</span>
            <strong>${{ cart.subtotal|floatformat:2 }}</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span>Sales Tax ({{ SALES_TAX_RATE|floatformat:2 }}×):</span>
            <strong>${{ cart.tax|floatformat:2 }}</strong>
          </div>
          <div class="d-flex justify-content-between border-top pt-2 mt-2">
            <span class="fw-bold">Total:</span>
            <strong class="fs-5 text-success">${{ cart.total|floatformat:2 }}</strong>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 d-flex justify-content-between flex-wrap gap-2">
          <div></div>
          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-outline-danger" id="cart-remove-selected">
              <i class="bi bi-x-circle"></i> Remove Selected
            </button>
            <button type="button" class="btn btn-outline-secondary" id="cart-clear-btn">
              <i class="bi bi-trash"></i> Clear Cart
            </button>
            <a class="btn btn-success" href="{% url 'billing:checkout' %}">
              <i class="bi bi-credit-card"></i> Proceed to Checkout
            </a>
          </div>
        </div>
      </form>
    {% else %}
      <div class="alert alert-info mb-0 text-center">
        Your cart is empty — drag available employees onto the 🛒 cart icon above.
      </div>
    {% endif %}
  </div>
</div>

<!-- ================================================================ -->
<!-- 🧠 CART INTERACTION SCRIPT -->
<!-- ================================================================ -->
<script>
(function() {
  // -----------------------------
  // ⚙️ CSRF Helper
  // -----------------------------
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (const c of cookies) {
      const [k, ...rest] = c.split('=');
      if (decodeURIComponent(k) === name) return decodeURIComponent(rest.join('='));
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // -----------------------------
  // 🧩 Drag Source Setup (from search page)
  // -----------------------------
  document.querySelectorAll('.draggable-emp[draggable="true"]').forEach(el => {
    el.addEventListener('dragstart', ev => {
      const payload = {
        employee_id: el.dataset.employeeId,
        service_category_id: el.dataset.serviceId,
        time_slot_id: el.dataset.timeSlotId,
        date: el.dataset.date
      };
      ev.dataTransfer.setData('application/json', JSON.stringify(payload));
      ev.dataTransfer.setData('text/plain', 'booking-item');
      ev.dataTransfer.effectAllowed = 'copy';
    });
  });

  // -----------------------------
  // 🛒 Drop to Cart Icon
  // -----------------------------
  const cartIcon = document.getElementById('cart-icon');
  const summaryLabel = document.getElementById('booking-summary');

  if (cartIcon) {
    cartIcon.addEventListener('dragover', ev => {
      ev.preventDefault();
      cartIcon.classList.add('bg-warning-subtle');
      ev.dataTransfer.dropEffect = 'copy';
    });
    cartIcon.addEventListener('dragleave', () => cartIcon.classList.remove('bg-warning-subtle'));
    cartIcon.addEventListener('drop', async ev => {
      ev.preventDefault();
      cartIcon.classList.remove('bg-warning-subtle');
      let data;
      try {
        data = JSON.parse(ev.dataTransfer.getData('application/json'));
      } catch (err) {
        console.warn('❌ Bad drop payload', err);
        return;
      }

      if (!data.employee_id || !data.service_category_id || !data.time_slot_id || !data.date) {
        alert('Missing required data.');
        return;
      }

      try {
        const response = await fetch("{% url 'billing:cart_add' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": csrftoken
          },
          body: new URLSearchParams(data).toString()
        });
        const result = await response.json();
        if (result.ok) {
          _replaceCartHTML(result.html);
          _updateSummary(result.summary_text);
          _flashCartIcon();
        } else alert(result.error || "Failed to add item to cart.");
      } catch (error) {
        console.error(error);
        alert("Network error while adding item.");
      }
    });
  }

  // -----------------------------
  // 🧹 Remove / Clear / Bulk Remove
  // -----------------------------
  document.addEventListener('click', async ev => {
    const removeBtn = ev.target.closest('[data-action="remove"]');
    const clearBtn = ev.target.id === 'cart-clear-btn';
    const bulkBtn = ev.target.id === 'cart-remove-selected';
    if (!removeBtn && !clearBtn && !bulkBtn) return;

    ev.preventDefault();
    let endpoint, body;

    if (removeBtn) {
      endpoint = "{% url 'billing:cart_remove' %}";
      body = new URLSearchParams({ item_id: removeBtn.dataset.itemId });
    } else if (clearBtn) {
      endpoint = "{% url 'billing:cart_clear' %}";
    } else if (bulkBtn) {
      endpoint = "{% url 'billing:remove_selected_from_cart' %}";
      const selected = Array.from(document.querySelectorAll('input[name="selected_items"]:checked'))
                            .map(cb => cb.value);
      if (!selected.length) {
        alert("Select at least one item to remove.");
        return;
      }
      body = new URLSearchParams();
      selected.forEach(id => body.append('selected_items', id));
    }

    try {
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrftoken
        },
        body
      });
      const result = await resp.json();
      if (result.ok) {
        _replaceCartHTML(result.html);
        _updateSummary(result.summary_text);
      } else alert(result.error || "Failed to update cart.");
    } catch (error) {
      console.error(error);
      alert("Network error while updating cart.");
    }
  });

  // -----------------------------
  // 🔁 Select All Checkbox (table header)
  // -----------------------------
  document.addEventListener("change", ev => {
    if (ev.target.id === "select-all") {
      const checkboxes = document.querySelectorAll('input[name="selected_items"]');
      checkboxes.forEach(cb => cb.checked = ev.target.checked);
    }
  });

  // -----------------------------
  // 🔁 Helpers
  // -----------------------------
  function _replaceCartHTML(html) {
    if (!html) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    const newCard = wrapper.querySelector('.card');
    const oldCard = document.querySelector('.card.mt-4.shadow-sm');
    if (newCard && oldCard) oldCard.replaceWith(newCard);
  }

  function _updateSummary(text) {
    if (summaryLabel && text) summaryLabel.textContent = text;
  }

  function _flashCartIcon() {
    if (!cartIcon) return;
    cartIcon.classList.add('btn-success');
    setTimeout(() => cartIcon.classList.remove('btn-success'), 600);
  }
})();
</script>
