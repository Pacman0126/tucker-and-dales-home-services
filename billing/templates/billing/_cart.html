{% load static %}

<div class="card mt-4 shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong>ðŸ›’ Your Booking Cart</strong>
    <span class="badge bg-dark">{{ cart.items.count }} item{{ cart.items.count|pluralize }}</span>
  </div>

  <div class="card-body">

    {% if cart and cart.items.exists %}
      <form id="cart-form" method="post">
        {% csrf_token %}
        <ul class="list-group mb-3" id="cart-item-list">
          {% for item in cart.items.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div class="d-flex align-items-start gap-3">
                <input type="checkbox" class="form-check-input mt-1" name="selected_items" value="{{ item.id }}">
                <div>
                  <div class="fw-semibold">{{ item.service_category.name }}</div>
                  <div class="small text-muted">
                    {{ item.date }} â€” {{ item.time_slot.label }} â€” {{ item.employee.name }}
                  </div>
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <span class="badge bg-secondary">
                  ${{ item.unit_price|floatformat:2 }}
                </span>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-danger"
                  data-action="remove"
                  data-item-id="{{ item.id }}">
                  Remove
                </button>
              </div>
            </li>
          {% endfor %}
        </ul>

        <!-- Totals -->
        <div class="border-top pt-3 mt-2">
          <div class="d-flex justify-content-between">
            <span>Subtotal:</span>
            <strong>${{ cart.subtotal|floatformat:2 }}</strong>
          </div>
          <div class="d-flex justify-content-between">
            <span>Sales Tax ({{ SALES_TAX_RATE|floatformat:2 }}Ã—):</span>
            <strong>${{ cart.tax|floatformat:2 }}</strong>
          </div>
          <div class="d-flex justify-content-between border-top pt-2 mt-2">
            <span class="fw-bold">Total:</span>
            <strong class="fs-5 text-success">${{ cart.total|floatformat:2 }}</strong>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="mt-4 d-flex justify-content-between flex-wrap gap-2">
          <div class="form-check">
            <input type="checkbox" id="select-all" class="form-check-input">
            <label for="select-all" class="form-check-label small">Select All</label>
          </div>

          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-outline-danger" id="cart-remove-selected">
              <i class="bi bi-x-circle"></i> Remove Selected
            </button>
            <button type="button" class="btn btn-outline-secondary" id="cart-clear-btn">
              <i class="bi bi-trash"></i> Clear Cart
            </button>
            <a class="btn btn-success" href="{% url 'billing:checkout' %}">
              <i class="bi bi-credit-card"></i> Proceed to Checkout
            </a>
          </div>
        </div>
      </form>

    {% else %}
      <div class="alert alert-info mb-0 text-center">
        Your cart is empty â€” drag available employees onto the ðŸ›’ cart icon above.
      </div>
    {% endif %}
  </div>
</div>

<!-- ================================================================ -->
<!-- ðŸ§  CART INTERACTION SCRIPT -->
<!-- ================================================================ -->
<script>
(function() {
  // -----------------------------
  // âš™ï¸ CSRF Helper
  // -----------------------------
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (const c of cookies) {
      const [k, ...rest] = c.split('=');
      if (decodeURIComponent(k) === name) return decodeURIComponent(rest.join('='));
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // -----------------------------
  // ðŸ§© Drag Source Setup
  // -----------------------------
  document.querySelectorAll('.draggable-emp[draggable="true"]').forEach(el => {
    el.addEventListener('dragstart', ev => {
      const payload = {
        employee_id: el.dataset.employeeId,
        service_category_id: el.dataset.serviceId,
        time_slot_id: el.dataset.timeSlotId,
        date: el.dataset.date
      };
      ev.dataTransfer.setData('application/json', JSON.stringify(payload));
      ev.dataTransfer.setData('text/plain', 'booking-item');
      ev.dataTransfer.effectAllowed = 'copy';
    });
  });

  // -----------------------------
  // ðŸ›’ Drop to Cart Icon
  // -----------------------------
  const cartIcon = document.getElementById('cart-icon');
  const summaryLabel = document.getElementById('booking-summary');
  if (cartIcon) {
    cartIcon.addEventListener('dragover', ev => {
      ev.preventDefault();
      cartIcon.classList.add('bg-warning-subtle');
      ev.dataTransfer.dropEffect = 'copy';
    });
    cartIcon.addEventListener('dragleave', () => cartIcon.classList.remove('bg-warning-subtle'));
    cartIcon.addEventListener('drop', async ev => {
      ev.preventDefault();
      cartIcon.classList.remove('bg-warning-subtle');
      let data;
      try {
        data = JSON.parse(ev.dataTransfer.getData('application/json'));
      } catch (err) {
        console.warn('âŒ Bad drop payload', err);
        return;
      }

      if (!data.employee_id || !data.service_category_id || !data.time_slot_id || !data.date) {
        alert('Missing required data.');
        return;
      }

      try {
        const response = await fetch("{% url 'billing:cart_add' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": csrftoken
          },
          body: new URLSearchParams(data).toString()
        });
        const result = await response.json();
        if (result.ok) {
          _replaceCartHTML(result.html);
          _updateSummary(result.summary_text);
          _flashCartIcon();
        } else alert(result.error || "Failed to add item to cart.");
      } catch (error) {
        console.error(error);
        alert("Network error while adding item.");
      }
    });
  }

  // -----------------------------
  // ðŸ§¹ Remove / Clear / Bulk Remove
  // -----------------------------
  document.addEventListener('click', async ev => {
    const removeBtn = ev.target.closest('[data-action="remove"]');
    const clearBtn = ev.target.id === 'cart-clear-btn';
    const bulkBtn = ev.target.id === 'cart-remove-selected';
    if (!removeBtn && !clearBtn && !bulkBtn) return;

    ev.preventDefault();
    let endpoint, body;

    if (removeBtn) {
      endpoint = "{% url 'billing:cart_remove' %}";
      body = new URLSearchParams({ item_id: removeBtn.dataset.itemId });
    } else if (clearBtn) {
      endpoint = "{% url 'billing:cart_clear' %}";
    } else if (bulkBtn) {
      endpoint = "{% url 'billing:remove_selected_from_cart' %}";
      const selected = Array.from(document.querySelectorAll('input[name="selected_items"]:checked'))
                            .map(cb => cb.value);
      if (!selected.length) {
        alert("Select at least one item to remove.");
        return;
      }
      body = new URLSearchParams();
      selected.forEach(id => body.append('selected_items', id));
    }

    try {
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrftoken
        },
        body
      });
      const result = await resp.json();
      if (result.ok) {
        _replaceCartHTML(result.html);
        _updateSummary(result.summary_text);
      } else alert(result.error || "Failed to update cart.");
    } catch (error) {
      console.error(error);
      alert("Network error while updating cart.");
    }
  });

  // -----------------------------
  // ðŸ” Select All Checkbox
  // -----------------------------
  document.addEventListener("change", ev => {
    if (ev.target.id === "select-all") {
      const checkboxes = document.querySelectorAll('input[name="selected_items"]');
      checkboxes.forEach(cb => cb.checked = ev.target.checked);
    }
  });

  // -----------------------------
  // ðŸ” Helpers
  // -----------------------------
  function _replaceCartHTML(html) {
    if (!html) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    const newCard = wrapper.querySelector('.card');
    const oldCard = document.querySelector('.card.mt-4.shadow-sm');
    if (newCard && oldCard) oldCard.replaceWith(newCard);
  }

  function _updateSummary(text) {
    if (summaryLabel && text) summaryLabel.textContent = text;
  }

  function _flashCartIcon() {
    if (!cartIcon) return;
    cartIcon.classList.add('btn-success');
    setTimeout(() => cartIcon.classList.remove('btn-success'), 600);
  }
})();
</script>
