{% extends "base.html" %}
{% load static %}
{% block title %}Payment History | Tucker & Daleâ€™s{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">ðŸ’³ Payment History</h5>
      <span class="badge bg-dark">{{ payments.count }} record{{ payments.count|pluralize }}</span>
    </div>

    <div class="card-body">
      {% if payments %}
      <form id="cancel-form" method="post">
        {% csrf_token %}
        <div class="table-responsive">
          <table class="table align-middle table-hover">
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>Date</th>
                <th>Service Address</th>
                <th>Amount</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in payments %}
              <tr class="
                  {% if p.status == 'Cancelled' %}table-light text-muted
                  {% elif p.status == 'Refunded' or p.amount < 0 %}table-warning
                  {% endif %}
              ">
                <td>
                  <input type="checkbox"
                         name="selected_payments"
                         value="{{ p.id }}"
                         {% if p.status in 'Cancelled,Refunded' %}disabled{% endif %}>
                </td>

                <td>{{ p.created_at|date:"Y-m-d H:i" }}</td>
                <td>{{ p.service_address }}</td>

                <td>
                  {% if p.amount < 0 %}
                    <span class="text-danger">-${{ p.amount|floatformat:2|cut:"-" }}</span>
                  {% else %}
                    ${{ p.amount|floatformat:2 }}
                  {% endif %}
                  {{ p.currency|upper }}
                </td>

                <td>
                  {% if p.status == 'Cancelled' %}
                    <span class="badge bg-secondary">Cancelled</span>
                  {% elif p.status == 'Refunded' %}
                    <span class="badge bg-warning text-dark">Refunded</span>
                  {% else %}
                    <span class="badge bg-success">Paid</span>
                  {% endif %}
                </td>

                <td class="d-flex flex-wrap gap-2">
                  {% if p.status == 'Paid' %}
                    <a href="{% url 'billing:download_receipt_pdf' p.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-file-earmark-pdf"></i> PDF
                    </a>
                  {% elif p.status == 'Refunded' %}
                    <button type="button"
                            class="btn btn-sm btn-outline-info"
                            data-refund-id="{{ p.raw_data.stripe_refund_id|default:'N/A' }}"
                            data-penalty="{{ p.raw_data.penalty_applied|yesno:'true,false' }}"
                            data-amount="{{ p.amount|floatformat:2 }}"
                            data-status="{{ p.status }}"
                            data-notes="{{ p.notes|escape }}">
                      Details
                    </button>
                    <a href="{% url 'billing:download_receipt_pdf' p.id %}" class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-file-earmark-pdf"></i>
                    </a>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Footer controls -->
        <div class="d-flex justify-content-between flex-wrap gap-2 mt-3">
          <div class="form-check">
            <input type="checkbox" class="form-check-input" id="selectAll">
            <label for="selectAll" class="form-check-label small">Select All</label>
          </div>

          <div class="d-flex gap-2 ms-auto">
            <button type="button" class="btn btn-outline-danger" id="cancel-selected">
              <i class="bi bi-x-circle"></i> Cancel Selected
            </button>

            <!-- ðŸ”™ NEW BUTTON -->
            <a href="{% url 'scheduling:search_timeslot' %}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left-circle"></i> Back to Search
            </a>

            <a href="{% url 'scheduling:search_timeslot' %}" class="btn btn-outline-success">
              <i class="bi bi-plus-circle"></i> Add Service
            </a>

            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#adjustmentModal">
              <i class="bi bi-pencil-square"></i> Adjustment
            </button>
          </div>
        </div>
      </form>

      {% else %}
      <div class="alert alert-info text-center mb-0">
        No payments found.
        <div class="mt-3">
          <a href="{% url 'scheduling:search_timeslot' %}" class="btn btn-outline-success">
            <i class="bi bi-search"></i> Go to Search
          </a>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- ðŸ’° Refund / Penalty Modal -->
<div class="modal fade" id="refundModal" tabindex="-1" aria-labelledby="refundModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-semibold" id="refundModalLabel">Refund Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p><strong>Refund ID:</strong> <span id="refund-id"></span></p>
        <p><strong>Penalty Applied:</strong> <span id="refund-penalty"></span></p>
        <p><strong>Refund Amount:</strong> $<span id="refund-amount"></span></p>
        <p><strong>Status:</strong> <span id="refund-status"></span></p>
        <p><strong>Notes:</strong> <span id="refund-notes"></span></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- âž• Add Service / Adjustment Modal -->
<div class="modal fade" id="adjustmentModal" tabindex="-1" aria-labelledby="adjustmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-light">
        <h5 class="modal-title fw-semibold" id="adjustmentModalLabel">Add / Remove Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="adjustmentForm">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Select Booking</label>
            <select class="form-select" name="booking_id" required>
              {% for b in bookings %}
              <option value="{{ b.id }}">{{ b.service_address }} â€” {{ b.date|date:"M j, Y" }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Adjustment Amount (USD)</label>
            <input type="number" step="0.01" class="form-control" name="delta_amount" placeholder="e.g. 25.00" required>
            <small class="text-muted">Positive = add service, negative = refund</small>
          </div>
          <div class="mb-3">
            <label class="form-label">Notes</label>
            <textarea name="note" class="form-control" rows="2" placeholder="Describe the adjustment..."></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-primary" id="submitAdjustment">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // âœ… Select-all logic
  document.addEventListener("change", e=>{
    if(e.target.id==="selectAll"){
      document.querySelectorAll('input[name="selected_payments"]').forEach(cb=>cb.checked=e.target.checked);
    }
  });

  // âœ… Bulk cancel via fetch
  document.getElementById("cancel-selected")?.addEventListener("click", async ()=>{
    const selected=[...document.querySelectorAll('input[name="selected_payments"]:checked')].map(cb=>cb.value);
    if(!selected.length){ alert("Select at least one payment to cancel."); return; }
    if(!confirm("Cancel selected services? Refunds/penalties may apply.")) return;

    const resp=await fetch("{% url 'billing:cancel_selected_services' %}",{
      method:"POST",
      headers:{
        "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8",
        "X-CSRFToken":document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))?.split('=')[1]||""
      },
      body:new URLSearchParams(selected.map(id=>['selected_payments',id]))
    });
    const data=await resp.json();
    if(data.ok){
      alert(data.summary || "Cancellation successful.");
      location.reload();
    }else{
      alert(data.error || "Cancellation failed.");
    }
  });

  // âœ… Refund Details modal
  document.addEventListener("click", e=>{
    const btn=e.target.closest("[data-refund-id]");
    if(!btn)return;
    document.getElementById("refund-id").textContent=btn.dataset.refundId||"N/A";
    document.getElementById("refund-penalty").textContent=btn.dataset.penalty==="true"?"Yes (50%)":"No";
    document.getElementById("refund-amount").textContent=btn.dataset.amount||"N/A";
    document.getElementById("refund-status").textContent=btn.dataset.status||"Refunded";
    document.getElementById("refund-notes").textContent=btn.dataset.notes||"â€”";
    new bootstrap.Modal(document.getElementById("refundModal")).show();
  });
})();
</script>
{% endblock %}
