{% extends "base.html" %}
{% load static %}

{% block secondary_nav %}
<nav id="secondaryNavbar"
  class="navbar secondary-navbar fixed-top shadow-sm"
  style="top:56px; z-index:1039;">
  <div class="container-fluid flex-wrap justify-content-between py-2">

    <!-- üîÑ Search Mode Toggle Pills -->
    <div class="btn-group mb-2 mb-lg-0" role="group" aria-label="Search mode selector">
      <a href="{% url 'scheduling:search_by_date' %}"
         class="btn btn-outline-primary {% if request.resolver_match.url_name == 'search_by_date' %}active{% endif %}">
        <i class="bi bi-calendar3"></i> Search by Date
      </a>
      <a href="{% url 'scheduling:search_by_time_slot' %}"
         class="btn btn-outline-primary {% if request.resolver_match.url_name == 'search_by_time_slot' %}active{% endif %}">
        <i class="bi bi-clock-history"></i> Search by Time Slot
      </a>
    </div>

    <!-- üîç Search Form -->
    <form
      id="searchForm"
      method="get"
      action="{% url request.resolver_match.app_name|add:':'|add:request.resolver_match.url_name %}"
      class="d-flex flex-wrap align-items-center gap-2 mt-2 mt-lg-0"
      role="search"
    >

      {% if request.resolver_match.url_name == "search_by_date" %}
        <input type="date" name="date" value="{{ request.GET.date|default:'' }}" class="form-control form-control-sm" required>
      {% elif request.resolver_match.url_name == "search_by_time_slot" %}
        <select name="time_slot" class="form-select form-select-sm" required>
          <option value="">Select time slot</option>
          {% for slot in time_slots %}
            <option value="{{ slot.id }}" {% if request.GET.time_slot == slot.id|stringformat:"s" %}selected{% endif %}>
              {{ slot.label }}
            </option>
          {% endfor %}
        </select>
      {% endif %}

      <!-- üè† Address input OR AJAX "Book for New Address" -->
      <div id="addressContainer">
        {% if not address_locked %}
          <input
            type="text"
            name="customer_address"
            placeholder="Enter your address"
            class="form-control form-control-sm"
            value="{{ request.GET.customer_address|default:'' }}"
            required
          >
        {% else %}
          <!-- Hidden field preserves locked address during search -->
          <input type="hidden" name="customer_address" value="{{ locked_address }}">
          <button
            type="button"
            id="unlockAddressBtn"
            class="btn btn-warning btn-sm fw-semibold ms-2"
            data-url="{% url 'scheduling:unlock_address' %}">
            <i class="bi bi-geo-alt"></i> Book for New Address
          </button>
        {% endif %}
      </div>

      <button type="submit" id="searchBtn" class="btn btn-warning btn-sm fw-semibold">
        <i class="bi bi-search"></i> Search
      </button>
    </form>

    <!-- üÜï New Search Button -->
    <button id="newSearchBtn" class="btn btn-outline-primary btn-sm fw-semibold">
      <i class="bi bi-arrow-repeat me-1"></i> New Search
    </button>

  </div>
</nav>

<!-- üåÄ Global Loading Overlay -->
<div id="loadingOverlay"
  class="d-none position-fixed top-0 start-0 w-100 h-100 bg-white bg-opacity-75 d-flex justify-content-center align-items-center"
  style="z-index:2000;">
  <div class="text-center">
    <div class="spinner-border text-success mb-3" role="status" style="width:3rem; height:3rem;"></div>
    <div class="fw-semibold text-dark">Finding available employees...</div>
  </div>
</div>

<!-- ‚öôÔ∏è Navbar & Unlock Behavior Script -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const navbar = document.getElementById("secondaryNavbar");
  const form = document.getElementById("searchForm");
  const newSearchBtn = document.getElementById("newSearchBtn");
  const overlay = document.getElementById("loadingOverlay");
  const searchBtn = document.getElementById("searchBtn");
  const unlockBtn = document.getElementById("unlockAddressBtn");

  // Detect existing query (collapse navbar after first search)
  const hasQuery = window.location.search.length > 0;
  if (hasQuery) navbar.classList.add("collapsed");

  // =========================================================
  // üîç Search submission with overlay + spinner
  // =========================================================
  form.addEventListener("submit", () => {
    overlay.classList.remove("d-none");
    navbar.classList.add("collapsed");

    const originalText = searchBtn.innerHTML;
    searchBtn.disabled = true;
    searchBtn.innerHTML =
      '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Searching...';

    // failsafe restore (4 seconds)
    setTimeout(() => {
      searchBtn.disabled = false;
      searchBtn.innerHTML = originalText;
    }, 4000);
  });

  // =========================================================
  // üîÑ New Search ‚Äî keep locked address hidden, clear other inputs
  // =========================================================
  newSearchBtn.addEventListener("click", () => {
    navbar.classList.remove("collapsed");

    form.querySelectorAll("input, select").forEach(el => {
      if (el.tagName === "SELECT") {
        el.selectedIndex = 0;
      } else if (el.type !== "hidden" && el.name !== "customer_address") {
        el.value = ""; // preserve hidden address if locked
      }
    });

    overlay.classList.add("d-none");
    searchBtn.disabled = false;

    // smooth scroll to top
    window.scrollTo({ top: 0, behavior: "smooth" });

    // focus first visible field after animation
    setTimeout(() => {
      const first = form.querySelector("input:not([type=hidden]), select");
      first?.focus();
    }, 300);
  });

  // =========================================================
  // üß≠ Unlock Address (AJAX reset + cart clear)
  // =========================================================
  if (unlockBtn) {
    unlockBtn.addEventListener("click", async () => {
      const url = unlockBtn.dataset.url;
      unlockBtn.disabled = true;
      const originalHTML = unlockBtn.innerHTML;
      unlockBtn.innerHTML =
        '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Resetting...';

      try {
        const response = await fetch(url, {
          method: "POST",
          headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "X-Requested-With": "XMLHttpRequest",
          },
        });

        if (response.ok) {
          // Replace hidden input with visible address field
          document.getElementById("addressContainer").innerHTML = `
            <input
              type="text"
              name="customer_address"
              placeholder="Enter your address"
              class="form-control form-control-sm"
              required
            >`;

          // reset visible cart indicators
          const summary = document.getElementById("booking-summary");
          if (summary) summary.innerText = "(0) ‚Äì ($0.00)";
          const badge = document.getElementById("cart-count");
          if (badge) badge.innerText = "0";

          alert("‚úÖ Cart cleared ‚Äî you can now book for a new address.");
        } else {
          alert("‚ö†Ô∏è Could not reset session. Please refresh the page.");
        }
      } catch (err) {
        console.error("Error unlocking address:", err);
        alert("‚ö†Ô∏è Network error while unlocking address.");
      } finally {
        unlockBtn.disabled = false;
        unlockBtn.innerHTML = originalHTML;
      }
    });
  }

  // =========================================================
  // üç™ Helper: CSRF token retrieval
  // =========================================================
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<!-- üåç Google Maps Async Loader -->
<script>
  window.gmapsReady = false;
  window._gmapsLoaded = false;
  function initMap() {
    if (window._gmapsLoaded) return;
    window._gmapsLoaded = true;
    window.gmapsReady = true;
    document.dispatchEvent(new Event("gmaps:ready"));
    console.log("‚úÖ Google Maps initialized globally");
  }
  window.addEventListener("error", (e) => {
    if (e.target.tagName === "SCRIPT" && e.target.src.includes("maps.googleapis.com")) {
      console.error("‚ùå Google Maps failed to load:", e);
      window.gmapsReady = false;
      document.dispatchEvent(new Event("gmaps:error"));
    }
  });
</script>
<script
  src="https://maps.googleapis.com/maps/api/js?key={{ GOOGLE_MAPS_BROWSER_KEY }}&callback=initMap&loading=async"
  async defer>
</script>
{% endblock %}
