{% load static %}
<!-- scheduling/_cart.html -->

<div class="card mt-4 shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <strong>🛒 Your Booking Cart</strong>
    <span class="badge bg-dark">{{ cart.items.count }} items</span>
  </div>

  <div class="card-body">

    {% if cart and cart.items.exists %}
      <ul class="list-group mb-3" id="cart-item-list">
        {% for item in cart.items.all %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">{{ item.service_category.name }}</div>
              <div class="small text-muted">
                {{ item.date }} — {{ item.time_slot.label }} — {{ item.employee.name }}
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <span class="badge bg-secondary">
                ${{ item.unit_price|floatformat:2 }}
              </span>
              <button
                class="btn btn-sm btn-outline-danger"
                data-action="remove"
                data-item-id="{{ item.id }}">
                Remove
              </button>
            </div>
          </li>
        {% endfor %}
      </ul>

      <!-- Totals -->
      <div class="border-top pt-3 mt-2">
        <div class="d-flex justify-content-between">
          <span>Subtotal:</span>
          <strong>${{ cart.subtotal|floatformat:2 }}</strong>
        </div>
        <div class="d-flex justify-content-between">
          <span>Sales Tax ({{ SALES_TAX_RATE|floatformat:2 }}×):</span>
          <strong>${{ cart.tax|floatformat:2 }}</strong>
        </div>
        <div class="d-flex justify-content-between border-top pt-2 mt-2">
          <span class="fw-bold">Total:</span>
          <strong class="fs-5 text-success">${{ cart.total|floatformat:2 }}</strong>
        </div>
      </div>

      <!-- Buttons -->
      <div class="mt-4 d-flex gap-2">
        <button class="btn btn-outline-secondary" id="cart-clear-btn">Clear Cart</button>
        <a class="btn btn-success" href="{% url 'billing:checkout' %}">
          Proceed to Checkout
        </a>
      </div>

    {% else %}
      <div class="alert alert-info mb-0 text-center">
        Your cart is empty — drag available employees onto the 🛒 cart icon above.
      </div>
    {% endif %}
  </div>
</div>

<!-- ================================================================ -->
<!-- 🧠 CART INTERACTION SCRIPT -->
<!-- ================================================================ -->
<script>
(function() {
  // -----------------------------
  // ⚙️ CSRF Helper
  // -----------------------------
  function getCookie(name) {
    const cookies = document.cookie ? document.cookie.split('; ') : [];
    for (const c of cookies) {
      const [k, ...rest] = c.split('=');
      if (decodeURIComponent(k) === name) return decodeURIComponent(rest.join('='));
    }
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // -----------------------------
  // 🧩 Drag Source Setup
  // -----------------------------
  document.querySelectorAll('.draggable-emp[draggable="true"]').forEach(el => {
    el.addEventListener('dragstart', ev => {
      const payload = {
        employee_id: el.dataset.employeeId,
        service_category_id: el.dataset.serviceId,
        time_slot_id: el.dataset.timeSlotId,
        date: el.dataset.date
      };
      ev.dataTransfer.setData('application/json', JSON.stringify(payload));
      ev.dataTransfer.setData('text/plain', 'booking-item'); // Safari fix
      ev.dataTransfer.effectAllowed = 'copy';
    });
  });

  // -----------------------------
  // 🛒 Cart Icon Drop Target
  // -----------------------------
  const cartIcon = document.getElementById('cart-icon');
  const summaryLabel = document.getElementById('booking-summary');
  if (cartIcon) {
    cartIcon.addEventListener('dragover', ev => {
      ev.preventDefault();
      cartIcon.classList.add('bg-warning-subtle');
      ev.dataTransfer.dropEffect = 'copy';
    });
    cartIcon.addEventListener('dragleave', () => {
      cartIcon.classList.remove('bg-warning-subtle');
    });
    cartIcon.addEventListener('drop', async ev => {
      ev.preventDefault();
      cartIcon.classList.remove('bg-warning-subtle');

      let data;
      try {
        data = JSON.parse(ev.dataTransfer.getData('application/json'));
      } catch (err) {
        console.warn('❌ Bad drop payload', err);
        return;
      }

      if (!data.employee_id || !data.service_category_id || !data.time_slot_id || !data.date) {
        alert('Missing required data.');
        return;
      }

      try {
        const response = await fetch("{% url 'scheduling:cart_add' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
            "X-CSRFToken": csrftoken
          },
          body: new URLSearchParams(data).toString()
        });
        const result = await response.json();
        if (result.ok) {
          _replaceCartHTML(result.html);
          _updateSummary(result.summary_text);
          _flashCartIcon();
        } else alert(result.error || "Failed to add item to cart.");
      } catch (error) {
        console.error(error);
        alert("Network error while adding item.");
      }
    });
  }

  // -----------------------------
  // 🧹 Remove / Clear Actions
  // -----------------------------
  document.addEventListener('click', async ev => {
    const removeBtn = ev.target.closest('[data-action="remove"]');
    const clearBtn = ev.target.id === 'cart-clear-btn';
    if (!removeBtn && !clearBtn) return;

    ev.preventDefault();
    const endpoint = removeBtn
      ? "{% url 'scheduling:cart_remove' %}"
      : "{% url 'scheduling:cart_clear' %}";
    const body = removeBtn
      ? new URLSearchParams({ item_id: removeBtn.dataset.itemId })
      : undefined;

    try {
      const resp = await fetch(endpoint, {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          "X-CSRFToken": csrftoken
        },
        body
      });
      const result = await resp.json();
      if (result.ok) {
        _replaceCartHTML(result.html);
        _updateSummary(result.summary_text);
      } else alert(result.error || "Failed to update cart.");
    } catch (error) {
      console.error(error);
      alert("Network error while updating cart.");
    }
  });

  // -----------------------------
  // 🔁 Helpers
  // -----------------------------
  function _replaceCartHTML(html) {
    if (!html) return;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = html;
    const newCard = wrapper.querySelector('.card');
    const oldCard = document.querySelector('.card.mt-4.shadow-sm');
    if (newCard && oldCard) oldCard.replaceWith(newCard);
  }

  function _updateSummary(text) {
    if (summaryLabel && text) summaryLabel.textContent = text;
  }

  function _flashCartIcon() {
    if (!cartIcon) return;
    cartIcon.classList.add('btn-success');
    setTimeout(() => cartIcon.classList.remove('btn-success'), 600);
  }
})();
</script>
